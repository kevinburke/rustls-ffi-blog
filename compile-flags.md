# Compilation Flags for rustls

In this step you're going to add compilation flags that will let you choose
between the OpenSSL implementation and the rustls implementation. This gets
a little bit tricky.

First let's talk a little bit about how C programs are configured. Generally
speaking the straightforward path is:

1. A `configure` script, invoked with different options (see `./configure
--help`), will check which features your OS and software package supports, and
then generate a `Makefile`.

2. Invoke `make` to build the software, maybe with different options depending
   on which software you want to build. This will compile binaries somewhere
   within the project directory.

3. Invoke `make install` to copy the built artifacts to a prefix directory of
   your choosing (`/usr/local` is common).

This gets more complicated:

- `Makefile.am` and `Makefile.in` may be used as inputs to help generate the
  `Makefile`.

- There are variants of `make`, for example `cmake`.

- Sometimes the `configure` script itself will be generated by a file named
`configure.ac`. To trigger a re-generation of the `configure` file, run
`autoreconf -fi`.

Most of these are part of the `autoconf` software
library. You can read more about autoconf, and the files it uses, here:
https://www.gnu.org/software/autoconf/manual/autoconf-2.61/html_node/Making-configure-Scripts.html

### What rustls files we need to load

When you build [rustls-ffi][rustls-ffi], there are two important files that get
built that we need to load:

- `rustls.h`. We need to ensure that the directory holding this file - which
should be named `include` - is _included_, i.e. makes it into the list of `-I`
flags that are passed to every compilation instruction.

- `librustls_ffi.a`. We need to make sure that the directory holding this file -
which should be named `lib` - is part of the list of LDFLAGS (`-l` flags) that
are passed to every compilation instruction.

Sometimes this will be done for you - if the two paths are:

```
/usr/include/rustls.h
/usr/lib/librustls_ffi.a
```

Then it is very possible that your program's compilation flags will
automatically pick up that directory. But if they are in a custom location, you
will need to find them in the custom location, and edit the compilation flags
accordingly.

### Editing the configure scripts to find rustls

To be honest, your author is not that great at providing a step by step guide
here. What worked best at this step was:

- Figure out how to compile the program with openssl, and the different options
  you need to do this.
- Look at existing scripts that have instructions for adding rustls, and attempt
  to adapt them for your project.
- Trial and error - iteratively make the smallest possible change and verify
  things are still compiling, then repeat until you have the project working.

Some things you will definitely want:

- The OpenSSL library may have a variable defined in `configure.ac` or a file
ending in `.m4` that has a name like `USE_OPENSSL` or `OPENSSL_ENABLED` or
similar. This is a good place to start. You want to define `USE_RUSTLS` or
`RUSTLS_ENABLED`, and copy the logic that defines the `USE_OPENSSL` variable for
your use case.
- You will want one call to `AC_CHECK_LIB`, to check that you found the `rustls`
  library in the right place. Here is how this is implemented in curl:

    ```
      AC_CHECK_LIB(rustls, rustls_connection_read,
       [
       AC_DEFINE(USE_RUSTLS, 1, [if rustls is enabled])
       AC_SUBST(USE_RUSTLS, [1])
       RUSTLS_ENABLED=1
       USE_RUSTLS="yes"
       ssl_msg="rustls"
       ],
       AC_MSG_ERROR([--with-rustls was specified but could not find rustls.]),
       -lpthread -ldl -lm)
    ```

    Copy other code from the same section that checks for OpenSSL.

### Add rustls shims

At this point you are going to want to add a new file that implements the shim
interface you built in Adding a Virtual TLS Interface. You don't need to worry
about the function calls, you can add crashes or empty returns. You just want to
get the code to compile at this step.

### Advice

At each step of the process, if things aren't working the way you expect,
you want to form a hypothesis and then try to validate it. You can read the
generated `configure` file to see where it is looking, and you can read the
output from `configure` in `config.log` to see where it failed (though you may
have to scroll up a few hundred lines to read the useful part of `config.log`).

For example, you might want to check that `configure` is up to date and includes
your most recent changes. Add nonsensical changes to e.g. `configure.ac`, and
then verify that the build crashes. If not, then you need to double check how to
regenerate `configure` from `configure.ac`.

Or if rustls isn't being loaded and you think it should be, remove the rustls
directory altogether and see if you get a different error message, or point the
configure script at a nonsensical directory.

The key is to make the smallest possible change and then find ways to
_rule out_ things that could cause whatever you are seeing. Eventually you will
find something odd that will be a place to spend more time looking.

### Asking for help

If you've tried this and you still can't figure it out, feel free to contact
members of the Memory Safety organization. Alternatively, you could add a post
on StackOverflow, or send a message to the mailing list for the community that
you're attempting to add the change to.

Remember the key steps of reporting a technical issue:

1. Explain what you are trying to do.
2. Explain what you expect to see.
3. Explain what you actually see.
4. Explain what steps you've tried, and what things you don't understand.

Best of luck!

[rustls-ffi]: https://github.com/rustls/rustls-ffi
